name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set deployment environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
      
      - name: Deploy to Coolify
        env:
          COOLIFY_WEBHOOK: ${{ secrets.COOLIFY_WEBHOOK_URL }}
          ENVIRONMENT: ${{ steps.env.outputs.ENVIRONMENT }}
        run: |
          # Trigger Coolify deployment webhook
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -d '{
              "environment": "'$ENVIRONMENT'",
              "image": "'${{ env.REGISTRY }}'/'${{ env.IMAGE_NAME }}':latest",
              "commit": "'${{ github.sha }}'",
              "branch": "'${{ github.ref_name }}'"
            }' \
            $COOLIFY_WEBHOOK
      
      - name: Verify deployment
        run: |
          sleep 30
          HEALTH_URL="${{ secrets.API_URL }}/healthz"
          response=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
          if [ $response -eq 200 ]; then
            echo "Deployment successful! API is healthy."
          else
            echo "Deployment verification failed. HTTP status: $response"
            exit 1
          fi
      
      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅' : '❌';
            const env = '${{ steps.env.outputs.ENVIRONMENT }}';
            const message = `${status} Deployment to ${env} ${{ job.status }}`;
            
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: '${{ job.status }}' === 'success' ? 'success' : 'failure',
              description: message,
              context: `deploy/${env}`
            });